name: Daily Market Scan & Newsletter

on:
  # Run every day at 8:00 AM IST (2:30 AM UTC)
  schedule:
    - cron: '30 2 * * *'  # Daily at 2:30 AM UTC (8:00 AM IST)
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      use_fmp:
        description: 'Use FMP enhanced fundamentals'
        required: false
        default: 'true'
      download_sec:
        description: 'Download SEC filings'
        required: false
        default: 'true'
      universe_source:
        description: 'Universe source (exchange, auto, fmp, finnhub)'
        required: false
        default: 'exchange'

jobs:
  daily-newsletter-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for caching
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ” Run Daily Newsletter Scan
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FREE_LLM_API_KEY: ${{ secrets.FREE_LLM_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          echo "ðŸš€ Starting daily market scan..."
          RUN_STARTED_AT="$(date -u +'%Y-%m-%d %H:%M:%S')"
          mkdir -p logs

          for required_secret in EMAIL_SENDER EMAIL_PASSWORD EMAIL_RECIPIENT; do
            if [ -z "${!required_secret}" ]; then
              echo "âŒ Missing required email secret: ${required_secret}"
              exit 1
            fi
          done

          # Persist shared email credentials to .env for workflow parity.
          cat > .env <<EOF
          EMAIL_SENDER=${EMAIL_SENDER}
          EMAIL_PASSWORD=${EMAIL_PASSWORD}
          EMAIL_RECIPIENT=${EMAIL_RECIPIENT}
          EOF
          set -a
          source .env
          set +a
          
          UNIVERSE_SOURCE="${{ github.event.inputs.universe_source || 'exchange' }}"
          echo "âœ“ Universe source: $UNIVERSE_SOURCE"

          # Build command with options
          CMD="python run_optimized_scan.py --workers 3 --delay 0.5 --universe-source $UNIVERSE_SOURCE --send-email"
          
          # Add FMP if enabled
          if [ "${{ github.event.inputs.use_fmp || 'true' }}" = "true" ]; then
            CMD="$CMD --use-fmp"
            echo "âœ“ FMP enhanced fundamentals enabled"
          fi
          
          # Add SEC downloads if enabled
          if [ "${{ github.event.inputs.download_sec || 'true' }}" = "true" ]; then
            CMD="$CMD --download-sec"
            echo "âœ“ SEC filing downloads enabled"
          fi
          
          echo "âœ“ Email newsletter enabled (--send-email)"
          
          echo "Running: $CMD"
          bash -lc "$CMD" 2>&1 | tee logs/daily_newsletter.log

          echo "ðŸ”Ž Verifying daily newsletter artifact freshness..."
          if ! find data/newsletters -maxdepth 1 -type f -name 'daily_newsletter_*.md' -newermt "$RUN_STARTED_AT" | grep -q .; then
            echo "âŒ No fresh daily newsletter artifact found in data/newsletters/daily_newsletter_*.md"
            exit 1
          fi

          DAILY_ARTIFACT_PATH="$(find data/newsletters -maxdepth 1 -type f -name 'daily_newsletter_*.md' -newermt "$RUN_STARTED_AT" | sort | tail -n 1)"
          echo "DAILY_ARTIFACT_PATH=${DAILY_ARTIFACT_PATH}" >> "$GITHUB_ENV"

          if grep -Eqi 'email.*(sent|success|delivered)' logs/daily_newsletter.log; then
            echo "DAILY_EMAIL_STATUS=âœ… Email send confirmed in logs" >> "$GITHUB_ENV"
          else
            echo "DAILY_EMAIL_STATUS=âŒ Email send not confirmed in logs (check logs/daily_newsletter.log)" >> "$GITHUB_ENV"
          fi
          echo "âœ… Fresh daily newsletter artifact detected"
      
      - name: ðŸ“Š Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scan-results-${{ github.run_number }}
          path: |
            data/daily_scans/*.txt
            data/daily_newsletter.md
            data/newsletters/daily_newsletter_*.md
            logs/daily_newsletter.log
          retention-days: 30
      
      - name: ðŸ’¾ Commit Results to Repository
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Add scan results
          git add data/daily_scans/latest_optimized_scan.txt || true
          git add data/daily_newsletter.md || true
          
          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“ˆ Daily scan results - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
      
      - name: ðŸš¨ Notify on Failure
        if: failure()
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          python -c "
          from src.notifications.email_notifier import EmailNotifier
          import os
          
          notifier = EmailNotifier()
          notifier.send_error_alert(
              'Daily market scan failed',
              'Check GitHub Actions logs for details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          )
          "
      
      - name: âœ… Summary
        if: always()
        run: |
          echo "## ðŸ“Š Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Newsletter artifact path: ${DAILY_ARTIFACT_PATH:-âŒ Not generated}" >> $GITHUB_STEP_SUMMARY
          echo "- Email send status: ${DAILY_EMAIL_STATUS:-âŒ Unknown (scan step may have failed before email check)}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/daily_newsletter.md" ]; then
            echo "âœ… Newsletter generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Preview:" >> $GITHUB_STEP_SUMMARY
            head -n 30 data/daily_newsletter.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Newsletter generation failed" >> $GITHUB_STEP_SUMMARY
          fi
