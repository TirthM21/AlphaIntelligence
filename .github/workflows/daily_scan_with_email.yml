name: Daily Market Scan & Newsletter

on:
  # Run every day at 8:00 AM IST (2:30 AM UTC)
  schedule:
    - cron: '30 2 * * *'  # Daily at 2:30 AM UTC (8:00 AM IST)
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      use_fmp:
        description: 'Use FMP enhanced fundamentals'
        required: false
        default: 'true'
      download_sec:
        description: 'Download SEC filings'
        required: false
        default: 'true'
      universe_source:
        description: 'Universe source (exchange, auto, fmp, finnhub)'
        required: false
        default: 'exchange'

jobs:
  daily-newsletter-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for caching
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üîç Run Daily Newsletter Scan
        id: daily_scan
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FREE_LLM_API_KEY: ${{ secrets.FREE_LLM_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          echo "üöÄ Starting daily market scan..."
          RUN_STARTED_AT="$(date -u +'%Y-%m-%d %H:%M:%S')"
          mkdir -p logs

          for required_secret in EMAIL_SENDER EMAIL_PASSWORD EMAIL_RECIPIENT; do
            if [ -z "${!required_secret}" ]; then
              echo "‚ùå Missing required email secret: ${required_secret}"
              exit 1
            fi
          done

          # Persist shared email credentials to .env for workflow parity.
          # Quote values so secrets containing spaces/shell tokens remain valid dotenv entries.
          {
            printf 'EMAIL_SENDER=%q\n' "$EMAIL_SENDER"
            printf 'EMAIL_PASSWORD=%q\n' "$EMAIL_PASSWORD"
            printf 'EMAIL_RECIPIENT=%q\n' "$EMAIL_RECIPIENT"
          } > .env
          
          UNIVERSE_SOURCE="${{ github.event.inputs.universe_source || 'exchange' }}"
          echo "‚úì Universe source: $UNIVERSE_SOURCE"

          # Build command with options
          CMD="python run_optimized_scan.py --workers 3 --delay 0.5 --universe-source $UNIVERSE_SOURCE --send-email --strict-email"
          
          # Add FMP if enabled
          if [ "${{ github.event.inputs.use_fmp || 'true' }}" = "true" ]; then
            CMD="$CMD --use-fmp"
            echo "‚úì FMP enhanced fundamentals enabled"
          fi
          
          # Add SEC downloads if enabled
          if [ "${{ github.event.inputs.download_sec || 'true' }}" = "true" ]; then
            CMD="$CMD --download-sec"
            echo "‚úì SEC filing downloads enabled"
          fi
          
          echo "‚úì Email newsletter enabled (--send-email)"
          
          echo "Running: $CMD"
          set -o pipefail
          bash -lc "$CMD" 2>&1 | tee logs/daily_newsletter.log
          SCAN_EXIT=$?

          echo "üîé Verifying daily newsletter artifact freshness..."
          ARTIFACT_EXIT=0
          if ! find data/newsletters -maxdepth 1 -type f -name 'daily_newsletter_*.md' -newermt "$RUN_STARTED_AT" | grep -q .; then
            echo "‚ùå No fresh daily newsletter artifact found in data/newsletters/daily_newsletter_*.md"
            ARTIFACT_EXIT=1
          else
            DAILY_ARTIFACT_PATH="$(find data/newsletters -maxdepth 1 -type f -name 'daily_newsletter_*.md' -newermt "$RUN_STARTED_AT" | sort | tail -n 1)"
            echo "DAILY_ARTIFACT_PATH=${DAILY_ARTIFACT_PATH}" >> "$GITHUB_ENV"
            echo "‚úÖ Fresh daily newsletter artifact detected"
          fi

          EMAIL_SUCCESS_COUNT="$(awk -F= '/^email_successes=/{print $2}' "$GITHUB_OUTPUT" | tail -n 1)"
          EMAIL_ATTEMPTS="$(awk -F= '/^email_attempts=/{print $2}' "$GITHUB_OUTPUT" | tail -n 1)"
          EMAIL_TARGETED="$(awk -F= '/^email_recipients_targeted=/{print $2}' "$GITHUB_OUTPUT" | tail -n 1)"
          EMAIL_FAILURE_REASON="$(awk -F= '/^email_top_failure_reason=/{print $2}' "$GITHUB_OUTPUT" | tail -n 1)"
          EMAIL_SUCCESS_COUNT="${EMAIL_SUCCESS_COUNT:-unknown}"
          EMAIL_ATTEMPTS="${EMAIL_ATTEMPTS:-unknown}"
          EMAIL_TARGETED="${EMAIL_TARGETED:-unknown}"
          EMAIL_FAILURE_REASON="${EMAIL_FAILURE_REASON:-unknown}"
          echo "DAILY_EMAIL_STATUS=attempts=${EMAIL_ATTEMPTS}, successes=${EMAIL_SUCCESS_COUNT}, targeted=${EMAIL_TARGETED}, top_failure_reason=${EMAIL_FAILURE_REASON}" >> "$GITHUB_ENV"

          if [ "$SCAN_EXIT" -ne 0 ]; then
            exit "$SCAN_EXIT"
          fi
          if [ "$ARTIFACT_EXIT" -ne 0 ]; then
            exit "$ARTIFACT_EXIT"
          fi
      
      - name: üìä Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scan-results-${{ github.run_number }}
          path: |
            data/daily_scans/*.txt
            data/daily_newsletter.md
            data/newsletters/daily_newsletter_*.md
            logs/daily_newsletter.log
          retention-days: 30
      
      - name: üíæ Commit Results to Repository
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Add scan results
          git add data/daily_scans/latest_optimized_scan.txt || true
          git add data/daily_newsletter.md || true
          
          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìà Daily scan results - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
      
      - name: ‚úÖ Summary
        if: always()
        run: |
          echo "## üìä Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Newsletter artifact path: ${DAILY_ARTIFACT_PATH:-‚ùå Not generated}" >> $GITHUB_STEP_SUMMARY
          echo "- Email send status: ${DAILY_EMAIL_STATUS:-‚ùå Unknown (scan step may have failed before email check)}" >> $GITHUB_STEP_SUMMARY
          echo "- Email JSON summary: `${{ steps.daily_scan.outputs.email_summary_json || 'N/A' }}`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/daily_newsletter.md" ]; then
            echo "‚úÖ Newsletter generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Preview:" >> $GITHUB_STEP_SUMMARY
            head -n 30 data/daily_newsletter.md >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Newsletter generation failed" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    runs-on: ubuntu-latest
    needs: market-scan
    if: always()

    steps:
      - name: Send success notification
        if: needs.market-scan.result == 'success'
        run: |
          echo "‚úÖ Daily market scan completed successfully"

      - name: Send failure notification
        if: needs.market-scan.result == 'failure'
        run: |
          echo "‚ùå Daily market scan failed - check logs"
          exit 1
