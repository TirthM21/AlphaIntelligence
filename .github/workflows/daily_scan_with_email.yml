name: Daily Market Scan & Newsletter

on:
  push:
    branches:
      - main
  # Run every day at 8:00 AM IST (2:30 AM UTC)
  schedule:
    - cron: '30 2 * * *'  # Daily at 2:30 AM UTC (8:00 AM IST)
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      use_fmp:
        description: 'Use FMP enhanced fundamentals'
        required: false
        default: 'true'
      download_sec:
        description: 'Download SEC filings'
        required: false
        default: 'true'
      send_email:
        description: 'Send email newsletter'
        required: false
        default: 'true'

jobs:
  market-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for caching
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“§ Email Diagnostic
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          echo "Checking email configuration..."
          python -c "
          import os
          from src.notifications.email_notifier import EmailNotifier
          notifier = EmailNotifier()
          print(f'Email Enabled: {notifier.enabled}')
          print(f'Sender: {notifier.sender_email}')
          print(f'Recipient: {notifier.recipient_email}')
          if not notifier.enabled:
              exit(1)
          "
      
      - name: ðŸ” Run Market Scan
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FREE_LLM_API_KEY: ${{ secrets.FREE_LLM_API_KEY }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          LOG_LEVEL: DEBUG
        run: |
          echo "ðŸš€ Starting daily market scan..."
          
          # Build command with options
          CMD="python run_optimized_scan.py --workers 3 --delay 0.5"
          
          # Add FMP if enabled
          if [ "${{ github.event.inputs.use_fmp || 'true' }}" = "true" ]; then
            CMD="$CMD --use-fmp"
            echo "âœ“ FMP enhanced fundamentals enabled"
          fi
          
          # Add SEC downloads if enabled
          if [ "${{ github.event.inputs.download_sec || 'true' }}" = "true" ]; then
            CMD="$CMD --download-sec"
            echo "âœ“ SEC filing downloads enabled"
          fi
          
          # Add email if enabled
          if [ "${{ github.event.inputs.send_email || 'true' }}" = "true" ]; then
            CMD="$CMD --send-email"
            echo "âœ“ Email newsletter enabled"
          fi
          
          echo "Running: $CMD"
          $CMD
      
      - name: ðŸ“Š Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scan-results-${{ github.run_number }}
          path: |
            data/daily_scans/*.txt
            data/daily_newsletter.md
          retention-days: 30
      
      - name: ðŸ’¾ Commit Results to Repository
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Add scan results
          git add data/daily_scans/latest_optimized_scan.txt || true
          git add data/daily_newsletter.md || true
          
          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“ˆ Daily scan results - $(date +'%Y-%m-%d %H:%M')"
            
            # Use a retry loop for pushing
            MAX_RETRIES=5
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Push attempt $((RETRY_COUNT + 1))..."
              if git push origin ${{ github.ref_name }}; then
                echo "âœ… Successfully pushed changes"
                SUCCESS=true
                break
              else
                echo "âŒ Push failed. Retrying in 10 seconds..."
                sleep 10
                git pull --rebase origin ${{ github.ref_name }}
                RETRY_COUNT=$((RETRY_COUNT + 1))
              fi
            done
            
            if [ "$SUCCESS" = false ]; then
              echo "âŒ Failed to push changes after $MAX_RETRIES attempts"
              exit 1
            fi
          fi
      
      - name: ðŸš¨ Notify on Failure
        if: failure()
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          python -c "
          from src.notifications.email_notifier import EmailNotifier
          import os
          
          notifier = EmailNotifier()
          notifier.send_error_alert(
              'Daily market scan failed',
              'Check GitHub Actions logs for details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          )
          "
      
      - name: âœ… Summary
        if: always()
        run: |
          echo "## ðŸ“Š Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/daily_newsletter.md" ]; then
            echo "âœ… Newsletter generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Preview:" >> $GITHUB_STEP_SUMMARY
            head -n 30 data/daily_newsletter.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Newsletter generation failed" >> $GITHUB_STEP_SUMMARY
          fi
