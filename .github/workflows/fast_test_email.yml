name: ‚ö° Fast Email Test
on:
  workflow_dispatch:

jobs:
  test_email:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv yfinance pandas openai

      - name: ‚úâÔ∏è Create and Send Test File
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          LOG_LEVEL: DEBUG
        run: |
          echo "Creating test report..."
          echo "Alpha Intelligence Fast Test Report" > test_report.txt
          echo "Timestamp: $(date)" >> test_report.txt
          echo "Status: SMTP Verification via GitHub Actions" >> test_report.txt
          
          python -c "
          from src.notifications.email_notifier import EmailNotifier
          import os
          
          notifier = EmailNotifier()
          if not notifier.enabled:
              print('‚ùå Error: Email credentials not found')
              exit(1)
              
          # Send a simple newsletter with the file attached
          with open('test_email.md', 'w') as f:
              f.write('# ‚ö° Fast SMTP Test Success\n\nThis is a rapid test executed from GitHub Actions to verify your SMTP configuration and file attachment logic.')
          
          success = notifier.send_newsletter(
              'test_email.md', 
              subject='‚ö° Alpha Intelligence: Fast SMTP Test',
              scan_report_path='test_report.txt'
          )
          
          if success:
              print('‚úÖ SUCCESS: Test email and file sent')
          else:
              print('‚ùå FAILURE: Could not send email')
              exit(1)
          "
