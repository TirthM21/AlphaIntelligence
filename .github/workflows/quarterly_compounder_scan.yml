name: Quarterly Compounder Scan

on:
  schedule:
    # Run quarterly: Jan 15, Apr 15, Jul 15, Oct 15
    - cron: '0 9 15 1 *'   # January 15 at 9 AM UTC
    - cron: '0 9 15 4 *'   # April 15 at 9 AM UTC
    - cron: '0 9 15 7 *'   # July 15 at 9 AM UTC
    - cron: '0 9 15 10 *'  # October 15 at 9 AM UTC

  # Allow manual trigger
  workflow_dispatch:

jobs:
  quarterly-newsletter-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Run quarterly newsletter scan
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FREE_LLM_API_KEY: ${{ secrets.FREE_LLM_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          RUN_STARTED_AT="$(date -u +'%Y-%m-%d %H:%M:%S')"
          mkdir -p logs

          for required_secret in EMAIL_SENDER EMAIL_PASSWORD EMAIL_RECIPIENT; do
            if [ -z "${!required_secret}" ]; then
              echo "‚ùå Missing required email secret: ${required_secret}"
              exit 1
            fi
          done

          # Persist shared email credentials to .env for workflow parity.
          # Quote values so secrets containing spaces/shell tokens remain valid dotenv entries.
          {
            printf 'EMAIL_SENDER=%q\n' "$EMAIL_SENDER"
            printf 'EMAIL_PASSWORD=%q\n' "$EMAIL_PASSWORD"
            printf 'EMAIL_RECIPIENT=%q\n' "$EMAIL_RECIPIENT"
          } > .env

          python run_quarterly_compounder_scan.py \
            --log-level INFO \
            --output-dir data/quarterly_reports \
            --send-email 2>&1 | tee logs/quarterly_newsletter.log

          echo "üîé Verifying quarterly newsletter artifact freshness..."
          if ! find data/newsletters/quarterly -maxdepth 1 -type f -name 'quarterly_compounder_*.md' -newermt "$RUN_STARTED_AT" | grep -q .; then
            echo "‚ùå No fresh quarterly newsletter artifact found in data/newsletters/quarterly/quarterly_compounder_*.md"
            exit 1
          fi

          QUARTERLY_ARTIFACT_PATH="$(find data/newsletters/quarterly -maxdepth 1 -type f -name 'quarterly_compounder_*.md' -newermt "$RUN_STARTED_AT" | sort | tail -n 1)"
          echo "QUARTERLY_ARTIFACT_PATH=${QUARTERLY_ARTIFACT_PATH}" >> "$GITHUB_ENV"

          if grep -Eqi 'email.*(sent|success|delivered)' logs/quarterly_newsletter.log; then
            echo "QUARTERLY_EMAIL_STATUS=‚úÖ Email send confirmed in logs" >> "$GITHUB_ENV"
          else
            echo "QUARTERLY_EMAIL_STATUS=‚ùå Email send not confirmed in logs (check logs/quarterly_newsletter.log)" >> "$GITHUB_ENV"
          fi
          echo "‚úÖ Fresh quarterly newsletter artifact detected"
        timeout-minutes: 30

      - name: Generate report summary
        if: success()
        run: |
          echo "## Quarterly Compounder Scan Complete ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Newsletter artifact path: ${QUARTERLY_ARTIFACT_PATH:-‚ùå Not generated}" >> $GITHUB_STEP_SUMMARY
          echo "- Email send status: ${QUARTERLY_EMAIL_STATUS:-‚ùå Unknown (scan step may have failed before email check)}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          ls -lh data/quarterly_reports/allocation_model_*.csv 2>/dev/null | awk '{print "- " $9}' >> $GITHUB_STEP_SUMMARY || echo "- CSV files pending" >> $GITHUB_STEP_SUMMARY

      - name: Commit reports to git
        if: success()
        run: |
          # Check if there are changes
          if [ -n "$(git status --porcelain data/quarterly_reports/)" ]; then
            git add data/quarterly_reports/

            # Get quarter designation
            MONTH=$(date +%m)
            YEAR=$(date +%Y)
            Q=$(( (MONTH - 1) / 3 + 1 ))

            git commit -m "chore: Quarterly compounder scan results Q${Q} ${YEAR}

            - Scored top 500 stocks with compounder engine
            - Identified top 25 individual compounders
            - Scored and selected top 10 thematic ETFs
            - Built optimal portfolio with concentration rules
            - Generated quarterly ownership reports
            - Calculated rebalance actions

            Automated by GitHub Actions quarterly_compounder_scan workflow.
            "
            git push
          else
            echo "No changes to commit"
          fi

      - name: Report failure to stderr
        if: failure()
        run: |
          echo "‚ùå Quarterly compounder scan failed"
          echo "Check workflow logs above for error details"
          exit 1

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quarterly-reports
          path: |
            data/quarterly_reports/
            data/newsletters/quarterly/quarterly_compounder_*.md
            logs/quarterly_newsletter.log
          retention-days: 90

  notify:
    runs-on: ubuntu-latest
    needs: quarterly-newsletter-scan
    if: always()

    steps:
      - name: Send success notification
        if: needs['quarterly-newsletter-scan'].result == 'success'
        run: |
          echo "‚úÖ Quarterly compounder scan completed successfully"

      - name: Send failure notification
        if: needs['quarterly-newsletter-scan'].result == 'failure'
        run: |
          echo "‚ùå Quarterly compounder scan failed - check logs"
          exit 1
