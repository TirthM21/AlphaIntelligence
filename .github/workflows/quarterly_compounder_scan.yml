name: Quarterly Compounder Scan

on:
  push:
    branches:
      - main
  schedule:
    # Run quarterly: Jan 15, Apr 15, Jul 15, Oct 15
    - cron: '0 9 15 1 *'   # January 15 at 9 AM UTC
    - cron: '0 9 15 4 *'   # April 15 at 9 AM UTC
    - cron: '0 9 15 7 *'   # July 15 at 9 AM UTC
    - cron: '0 9 15 10 *'  # October 15 at 9 AM UTC

  # Allow manual trigger
  workflow_dispatch:

jobs:
  quarterly_scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üìß Email Diagnostic
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          echo "Checking email configuration..."
          python -c "
          import os
          from src.notifications.email_notifier import EmailNotifier
          notifier = EmailNotifier()
          print(f'Email Enabled: {notifier.enabled}')
          print(f'Sender: {notifier.sender_email}')
          print(f'Recipient: {notifier.recipient_email}')
          if not notifier.enabled:
              exit(1)
          "

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Run quarterly compounder scan
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FREE_LLM_API_KEY: ${{ secrets.FREE_LLM_API_KEY }}
        run: |
          python run_quarterly_compounder_scan.py \
            --log-level INFO \
            --output-dir data/quarterly_reports
        timeout-minutes: 30

      - name: Generate report summary
        if: success()
        run: |
          echo "## Quarterly Compounder Scan Complete ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          ls -lh data/quarterly_reports/allocation_model_*.csv 2>/dev/null | awk '{print "- " $9}' >> $GITHUB_STEP_SUMMARY || echo "- CSV files pending" >> $GITHUB_STEP_SUMMARY

      - name: Commit reports to git
        if: success()
        run: |
          # Check if there are changes
          if [ -n "$(git status --porcelain data/quarterly_reports/)" ]; then
            git add data/quarterly_reports/

            # Get quarter designation
            MONTH=$(date +%m)
            YEAR=$(date +%Y)
            Q=$(( (MONTH - 1) / 3 + 1 ))

            git commit -m "chore: Quarterly compounder scan results Q${Q} ${YEAR}

            - Scored top 500 stocks with compounder engine
            - Identified top 25 individual compounders
            - Scored and selected top 10 thematic ETFs
            - Built optimal portfolio with concentration rules
            - Generated quarterly ownership reports
            - Calculated rebalance actions

            Automated by GitHub Actions quarterly_compounder_scan workflow.
            "
            # Use a retry loop for pushing
            MAX_RETRIES=5
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Push attempt $((RETRY_COUNT + 1))..."
              if git push origin ${{ github.ref_name }}; then
                echo "‚úÖ Successfully pushed changes"
                SUCCESS=true
                break
              else
                echo "‚ùå Push failed. Retrying in 10 seconds..."
                sleep 10
                git pull --rebase origin ${{ github.ref_name }}
                RETRY_COUNT=$((RETRY_COUNT + 1))
              fi
            done
            
            if [ "$SUCCESS" = false ]; then
              echo "‚ùå Failed to push changes after $MAX_RETRIES attempts"
              exit 1
            fi
          else
            echo "No changes to commit"
          fi

      - name: Report failure to stderr
        if: failure()
        run: |
          echo "‚ùå Quarterly compounder scan failed"
          echo "Check workflow logs above for error details"
          exit 1

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quarterly-reports
          path: data/quarterly_reports/
          retention-days: 90

      - name: üìß Send Email Notification
        if: always()
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          SCAN_STATUS: ${{ job.status }}
        run: |
          python -c "
          from src.notifications.email_notifier import EmailNotifier
          import os
          from datetime import datetime
          
          notifier = EmailNotifier()
          if not notifier.enabled:
              print('Email not configured, skipping...')
              exit(0)
              
          status = os.getenv('SCAN_STATUS', 'unknown')
          date_str = datetime.now().strftime('%Y-%m-%d')
          
          if status == 'success':
              subject = f'‚úÖ Quarterly Compounder Scan Complete - {date_str}'
              body = 'The quarterly stock scan has completed successfully. You can find the reports in the data/quarterly_reports directory or as artifacts in the GitHub Action run.'
          else:
              subject = f'üö® Quarterly Compounder Scan FAILED - {date_str}'
              body = 'The quarterly stock scan has failed. Please check the GitHub Actions logs for details.'
          
          # Simple markdown to HTML conversion
          with open('summary_email.md', 'w') as f:
              f.write(f'# {subject}\n\n{body}\n\n[View Run Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})')
          
          notifier.send_newsletter('summary_email.md', subject=subject)
          "
